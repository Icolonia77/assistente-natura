import streamlit as st
import pandas as pd
import graphviz
import re
from io import StringIO

# ==============================================================================
# CONFIGURA√á√ÉO DA P√ÅGINA
# ==============================================================================
st.set_page_config(
    page_title="Motor de Campanhas CRM - Natura",
    page_icon="üåø",
    layout="wide"
)

# ==============================================================================
# FUN√á√ïES DOS AGENTES E PROCESSAMENTO (Simula√ß√£o)
# ==============================================================================

def simular_organizador_de_contexto(diretrizes, planos_anteriores):
    """
    Simula o agente "Organizador de Contexto".
    Extrai informa√ß√µes relevantes dos textos de entrada.
    """
    if not diretrizes and not planos_anteriores:
        return "Aguardando input de diretrizes e planejamentos..."
    
    # Em um projeto real, aqui entraria um modelo de NLP para sumariza√ß√£o.
    # Para o prot√≥tipo, fazemos uma extra√ß√£o simples de palavras-chave.
    info_relevantes = "### Informa√ß√µes de Neg√≥cio Relevantes\n\n"
    if diretrizes:
        info_relevantes += f"**Diretrizes de Comunica√ß√£o:**\n- Foco em sustentabilidade e produtos da linha Ekos.\n- Tom de voz: pr√≥ximo e inspirador.\n- Promo√ß√£o principal: 20% de desconto na primeira compra.\n\n"
    if planos_anteriores:
        info_relevantes += f"**Aprendizados de Planos Anteriores:**\n- Campanhas de SMS tiveram alta taxa de convers√£o para o p√∫blico jovem.\n- E-mails com v√≠deos de tutoriais aumentaram o engajamento em 30%.\n- Evitar comunica√ß√£o excessiva aos s√°bados."
    
    return info_relevantes

def simular_especialista_de_dados(df):
    """
    Simula o agente "Especialista de Dados".
    Gera um direcional de performance a partir dos dados das consultoras.
    """
    if df is None:
        return "Aguardando carregamento dos dados de perfil das consultoras..."
        
    # Em um projeto real, aqui entraria uma an√°lise estat√≠stica mais profunda.
    # Para o prot√≥tipo, calculamos algumas m√©dias e destaques.
    media_vendas = df['vendas_ultimo_ciclo'].mean()
    media_engajamento = df['taxa_engajamento'].mean()
    
    direcional = f"""
    ### Direcional de Performance Detalhado
    
    - **Performance de Vendas:** A m√©dia de vendas no √∫ltimo ciclo foi de **R$ {media_vendas:.2f}**. Consultoras da regi√£o Sudeste apresentaram performance 15% acima da m√©dia.
    - **N√≠vel de Engajamento:** A taxa m√©dia de engajamento com as comunica√ß√µes √© de **{media_engajamento:.1f}%**. As consultoras com menos de 6 meses de casa possuem engajamento 20% menor e representam uma oportunidade de atua√ß√£o.
    - **Recomenda√ß√£o:** Focar em campanhas de reativa√ß√£o para consultoras com vendas abaixo da m√©dia e engajamento baixo.
    """
    return direcional

def gerar_fluxograma_campanha(id_campanha, descricao_textual):
    """
    Gera um objeto de grafo Graphviz a partir de uma descri√ß√£o textual.
    (Fun√ß√£o adaptada da nossa conversa anterior).
    """
    dot = graphviz.Digraph(
        comment=f'Fluxograma da Campanha {id_campanha}',
        graph_attr={'rankdir': 'TB', 'bgcolor': 'transparent', 'splines': 'ortho'},
        node_attr={'shape': 'box', 'style': 'rounded,filled', 'fillcolor': '#FFFFFF', 'fontname': 'Helvetica'},
        edge_attr={'fontname': 'Helvetica', 'fontsize': '10'}
    )
    
    # Fun√ß√£o interna para parsear o texto
    def extrair_etapas_e_conexoes(descricao):
        etapas = {}
        conexoes = []
        for i, linha in enumerate(descricao.strip().split('\n')):
            linha = linha.strip()
            if not linha: continue
            
            tipo_match = re.match(r"(\w+):(.+)", linha)
            conexao_match = re.match(r"CONEX√ÉO:\s*(.+?)\s*->\s*(.+?)(?:\s*\[(.+?)\])?", linha)

            if conexao_match:
                origem, destino, rotulo = conexao_match.groups()
                conexoes.append({'origem': origem.strip(), 'destino': destino.strip(), 'rotulo': rotulo.strip() if rotulo else ''})
            elif tipo_match:
                tipo, nome = tipo_match.groups()
                tipo = tipo.strip().upper()
                nome = nome.strip()
                etapas[nome] = {'tipo': tipo, 'id': f'id_{i}'}
        return etapas, conexoes

    etapas, conexoes = extrair_etapas_e_conexoes(descricao_textual)

    for nome, attrs in etapas.items():
        cor = '#BBDEFB' # Azul padr√£o
        forma = 'box'
        if attrs['tipo'] == 'IN√çCIO':
            cor, forma = '#C8E6C9', 'circle' # Verde
        elif attrs['tipo'] == 'FIM':
            cor, forma = '#FFCDD2', 'doublecircle' # Vermelho
        elif attrs['tipo'] == 'DECIS√ÉO':
            cor, forma = '#FFF9C4', 'diamond' # Amarelo
        dot.node(attrs['id'], nome, shape=forma, fillcolor=cor)

    for conexao in conexoes:
        id_origem = etapas.get(conexao['origem'], {}).get('id')
        id_destino = etapas.get(conexao['destino'], {}).get('id')
        if id_origem and id_destino:
            dot.edge(id_origem, id_destino, label=conexao['rotulo'])

    return dot

# ==============================================================================
# INTERFACE DA APLICA√á√ÉO (Streamlit UI)
# ==============================================================================

st.title("üåø Motor de Planejamento de Campanhas CRM")
st.markdown("Prot√≥tipo funcional para automatizar a estrat√©gia, o planejamento e a cria√ß√£o de campanhas de CRM.")

# Inicializa√ß√£o do estado da sess√£o para guardar dados entre as p√°ginas
if 'dados_carregados' not in st.session_state:
    st.session_state['dados_carregados'] = False
if 'df_perfis' not in st.session_state:
    st.session_state['df_perfis'] = None
if 'df_segmentado' not in st.session_state:
    st.session_state['df_segmentado'] = None

# --- Abas para simular o fluxo ---
tab1, tab2, tab3 = st.tabs(["üìä Fase 1: Fontes de Dados", "üß† Fase 2: Processamento e Planejamento", "üöÄ Fase 3: Outputs Finais"])

# ============================================================
# ABA 1: FONTES DE DADOS
# ============================================================
with tab1:
    st.header("Carregue as Fontes de Dados")
    st.markdown("Nesta etapa, fornecemos os insumos para os agentes inteligentes. Em produ√ß√£o, isso ser√° feito via APIs.")

    col1, col2 = st.columns(2)

    with col1:
        st.subheader("Dados Estruturados")
        uploaded_file = st.file_uploader("Carregue o arquivo de Perfil e Mensura√ß√£o CB (CSV)", type="csv")
        if uploaded_file or st.session_state['df_perfis'] is not None:
            if uploaded_file:
                st.session_state['df_perfis'] = pd.read_csv(uploaded_file)
            st.success("Dados de perfil carregados com sucesso!")
            st.dataframe(st.session_state['df_perfis'].head())
        else:
            st.info("Aguardando arquivo CSV. O arquivo deve conter colunas como 'id_consultora', 'regiao', 'vendas_ultimo_ciclo', 'taxa_engajamento'.")

    with col2:
        st.subheader("Dados N√£o Estruturados")
        diretrizes_input = st.text_area("Cole aqui as Diretrizes de Comunica√ß√£o", height=150, key="diretrizes")
        planos_input = st.text_area("Cole aqui os insights de Planejamentos Anteriores", height=150, key="planos")

    if st.button("‚ñ∂Ô∏è Iniciar Processamento e Ir para a Fase 2", type="primary"):
        if st.session_state['df_perfis'] is None:
            st.error("Por favor, carregue o arquivo CSV de perfis antes de continuar.")
        else:
            st.session_state['dados_carregados'] = True
            st.success("Dados processados! Navegue para a Fase 2 para ver os resultados.")

# ============================================================
# ABA 2: PROCESSAMENTO E PLANEJAMENTO
# ============================================================
with tab2:
    if not st.session_state['dados_carregados']:
        st.warning("Por favor, carregue os dados na Fase 1 primeiro.")
    else:
        st.header("Outputs dos Agentes e Planejamento")
        
        # --- Outputs dos Agentes ---
        st.subheader("Resultados do Processamento Inicial")
        with st.expander("üìÑ Organizador de Contexto", expanded=True):
            resultado_organizador = simular_organizador_de_contexto(st.session_state.diretrizes, st.session_state.planos)
            st.markdown(resultado_organizador)
            
        with st.expander("üìà Especialista de Dados", expanded=True):
            resultado_especialista = simular_especialista_de_dados(st.session_state.df_perfis)
            st.markdown(resultado_especialista)
            
        st.divider()

        # --- Seletor de P√∫blico Interativo ---
        st.subheader("üéØ Seletor de P√∫blico (Interativo)")
        st.markdown("Use os filtros para segmentar a base de consultoras e definir o p√∫blico da sua campanha.")
        
        df_para_filtrar = st.session_state.df_perfis.copy()
        
        col_filtro1, col_filtro2 = st.columns(2)
        with col_filtro1:
            regioes_disponiveis = df_para_filtrar['regiao'].unique()
            regioes_selecionadas = st.multiselect("Filtrar por Regi√£o", regioes_disponiveis, default=regioes_disponiveis)
        
        with col_filtro2:
            max_vendas = int(df_para_filtrar['vendas_ultimo_ciclo'].max())
            filtro_vendas = st.slider("Filtrar por Vendas no √öltimo Ciclo (R$)", 0, max_vendas, (0, max_vendas))

        # Aplicando os filtros
        df_filtrado = df_para_filtrar[
            (df_para_filtrar['regiao'].isin(regioes_selecionadas)) &
            (df_para_filtrar['vendas_ultimo_ciclo'].between(filtro_vendas[0], filtro_vendas[1]))
        ]
        
        st.metric(
            label="Quantidade de Pessoas na Segmenta√ß√£o",
            value=len(df_filtrado),
            delta=f"{len(df_filtrado) - len(df_para_filtrar)} em rela√ß√£o ao total"
        )
        st.dataframe(df_filtrado)
        
        if st.button("üíæ Salvar Segmenta√ß√£o e Definir L√≥gica"):
            st.session_state['df_segmentado'] = df_filtrado
            st.success("Segmenta√ß√£o salva!")

        # --- Planejador de Campanhas ---
        if st.session_state['df_segmentado'] is not None:
            st.subheader("üìù Planejador de Campanhas de CRM")
            st.markdown("Descreva a l√≥gica da sua campanha abaixo. Use as palavras-chave `IN√çCIO`, `FIM`, `ETAPA`, `DECIS√ÉO` e `CONEX√ÉO`.")
            
            exemplo_logica = """IN√çCIO: In√≠cio da Campanha Q3
ETAPA: Enviar E-mail com Novidades Ekos
DECIS√ÉO: Abriu o e-mail em 3 dias?
ETAPA: Enviar Cupom 20% via SMS
ETAPA: Adicionar √† lista de "Alto Engajamento"
FIM: Fim do fluxo de sucesso
ETAPA: Ligar para reativar
FIM: Fim do fluxo de reativa√ß√£o

CONEX√ÉO: In√≠cio da Campanha Q3 -> Enviar E-mail com Novidades Ekos
CONEX√ÉO: Enviar E-mail com Novidades Ekos -> Abriu o e-mail em 3 dias?
CONEX√ÉO: Abriu o e-mail em 3 dias? -> Enviar Cupom 20% via SMS [Sim]
CONEX√ÉO: Enviar Cupom 20% via SMS -> Adicionar √† lista de "Alto Engajamento"
CONEX√ÉO: Adicionar √† lista de "Alto Engajamento" -> Fim do fluxo de sucesso
CONEX√ÉO: Abriu o e-mail em 3 dias? -> Ligar para reativar [N√£o]
CONEX√ÉO: Ligar para reativar -> Fim do fluxo de reativa√ß√£o
"""
            st.session_state['logica_campanha'] = st.text_area("L√≥gica da Campanha:", value=exemplo_logica, height=300)

# ============================================================
# ABA 3: OUTPUTS FINAIS
# ============================================================
with tab3:
    if 'logica_campanha' not in st.session_state or not st.session_state['logica_campanha']:
        st.warning("Por favor, defina e salve a segmenta√ß√£o e a l√≥gica da campanha na Fase 2.")
    else:
        st.header("Gera√ß√£o dos Artefatos Finais da Campanha")

        if st.button("‚ú® Gerar Todos os Outputs da Campanha", type="primary", use_container_width=True):
            
            # --- 1. Fluxograma com estrat√©gia ---
            st.subheader("1. Fluxograma com Estrat√©gia de Audi√™ncia e Canais")
            try:
                fluxo_gerado = gerar_fluxograma_campanha("Prot√≥tipo_Streamlit", st.session_state.logica_campanha)
                st.graphviz_chart(fluxo_gerado)
                st.success("Fluxograma gerado com sucesso!")
            except Exception as e:
                st.error(f"Erro ao gerar o fluxograma: {e}")

            st.divider()

            # --- 2. Google Sheet com estrat√©gia (simula√ß√£o) ---
            st.subheader("2. Planilha com Estrat√©gia de Audi√™ncia")
            st.markdown("Abaixo est√° a audi√™ncia final segmentada para a campanha. Clique para fazer o download.")
            
            df_final = st.session_state.df_segmentado
            st.dataframe(df_final)

            @st.cache_data
            def convert_df_to_csv(df):
                return df.to_csv(index=False).encode('utf-8')

            st.download_button(
                label="üì• Baixar Estrat√©gia de Audi√™ncia (CSV)",
                data=convert_df_to_csv(df_final),
                file_name="estrategia_audiencia_campanha.csv",
                mime="text/csv",
            )
            
            st.divider()

            # --- 3. Or√ßamento e Cronograma (simula√ß√£o) ---
            st.subheader("3. Or√ßamento e Cronograma (Simula√ß√£o)")
            orcamento_data = {
                'Item': ['Disparos de E-mail', 'Disparos de SMS', 'Custo da Liga√ß√£o (Call Center)'],
                'Quantidade': [len(df_final), len(df_final[df_final['taxa_engajamento'] > 50]), len(df_final[df_final['taxa_engajamento'] <= 50])],
                'Custo Unit√°rio (R$)': [0.05, 0.15, 2.50],
            }
            df_orcamento = pd.DataFrame(orcamento_data)
            df_orcamento['Custo Total (R$)'] = df_orcamento['Quantidade'] * df_orcamento['Custo Unit√°rio (R$)']
            st.table(df_orcamento)
            st.metric("Custo Total Estimado da Campanha", f"R$ {df_orcamento['Custo Total (R$)'].sum():.2f}")
            
            st.divider()

            # --- 4. Campanha desenhada no Salesforce (simula√ß√£o) ---
            st.subheader("4. Campanha Desenhada no Salesforce (Simula√ß√£o)")
            st.markdown("A etapa final seria a cria√ß√£o autom√°tica da campanha no Salesforce via API. O payload da requisi√ß√£o seria semelhante a este:")
            st.code(f"""
{{
  "campaign_name": "Campanha Q3 - Novidades Ekos",
  "target_audience_id": "lista_segmentada_{pd.Timestamp.now().strftime('%Y%m%d')}",
  "status": "Planned",
  "steps": [
    {{ "step": 1, "type": "email", "template_id": "template_ekos_novidades" }},
    {{ "step": 2, "type": "decision", "condition": "email_opened_in_3_days" }},
    {{ "step": 3, "type": "sms", "template_id": "sms_cupom_20" }},
    ...
  ]
}}
            """, language="json")